<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Renderizado de Alto Rango Dinámico | Learn Wgpu - Español</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/learn-wgpu-es/assets/css/0.styles.54a9523f.css" as="style"><link rel="preload" href="/learn-wgpu-es/assets/js/app.fb31abca.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/2.1022e2be.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/1.4766453e.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/13.8eb85f08.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/23.247ad87d.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/22.5d980ee9.js" as="script"><link rel="prefetch" href="/learn-wgpu-es/assets/js/10.85d1b333.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/11.3c198606.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/12.97c631a2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/14.f56f5783.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/15.f146080a.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/16.b78eff55.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/17.ac1b915c.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/18.d64e2c10.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/19.b80b7231.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/20.5525796a.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/21.d2868a6a.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/24.086d80a7.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/25.0ba438e3.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/26.aed3aec3.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/27.b4a1c2ae.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/28.2764cb5c.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/29.58f67d16.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/3.210ed7b2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/30.c5e766e5.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/31.5a6c1c03.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/32.b00abf9b.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/33.c2bc481b.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/34.f2bc04d8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/35.58c2c8d8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/36.d4783bfb.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/37.0f259387.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/38.3c99ab64.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/39.84e651b2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/4.db40dd96.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/40.56d1e232.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/41.f90ff503.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/42.7911692d.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/43.4f83f7e5.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/44.943c009e.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/45.0ab6ac73.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/46.c4185287.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/47.777cc2bf.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/48.96be8e13.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/49.aa04b1d6.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/5.6fdb9071.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/50.4022d2a0.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/51.3c411e45.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/52.2918a592.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/53.ee6c7c86.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/54.ec95ed52.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/55.da436f39.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/56.a7464507.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/57.38978bd1.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/58.f03403ea.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/59.d0f0d3af.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/60.675b3161.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/61.0d9a5510.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/62.cb765cf3.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/8.c8ddf2a2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/9.28f40848.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/vendors~docsearch.ccaccf87.js">
    <link rel="stylesheet" href="/learn-wgpu-es/assets/css/0.styles.54a9523f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu-es/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu - Español</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu-es/" aria-current="page" class="sidebar-link">Introducción</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Principiante</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-es/beginner/tutorial1-window/" class="sidebar-link">Dependencias y la ventana</a></li><li><a href="/learn-wgpu-es/beginner/tutorial2-surface/" class="sidebar-link">La Superficie</a></li><li><a href="/learn-wgpu-es/beginner/tutorial3-pipeline/" class="sidebar-link">El Pipeline</a></li><li><a href="/learn-wgpu-es/beginner/tutorial4-buffer/" class="sidebar-link">Búferes e Índices</a></li><li><a href="/learn-wgpu-es/beginner/tutorial5-textures/" class="sidebar-link">Texturas y grupos de enlace</a></li><li><a href="/learn-wgpu-es/beginner/tutorial6-uniforms/" class="sidebar-link">Búferes uniformes y una cámara 3D</a></li><li><a href="/learn-wgpu-es/beginner/tutorial7-instancing/" class="sidebar-link">Instanciación</a></li><li><a href="/learn-wgpu-es/beginner/tutorial8-depth/" class="sidebar-link">El Búfer de Profundidad</a></li><li><a href="/learn-wgpu-es/beginner/tutorial9-models/" class="sidebar-link">Carga de Modelos</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Intermedio</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-es/intermediate/tutorial10-lighting/" class="sidebar-link">Trabajando con Luces</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial11-normals/" class="sidebar-link">Mapeo de Normales</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial12-camera/" class="sidebar-link">Una Cámara Mejor</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/" aria-current="page" class="active sidebar-link">Renderizado de Alto Rango Dinámico</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#¿que-es-el-alto-rango-dinamico" class="sidebar-link">¿Qué es el Alto Rango Dinámico?</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#cambio-a-hdr" class="sidebar-link">Cambio a HDR</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#mapeo-de-tonos" class="sidebar-link">Mapeo de Tonos</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#cargando-texturas-hdr" class="sidebar-link">Cargando texturas HDR</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#texturas-equirectangulares" class="sidebar-link">Texturas Equirectangulares</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#mapas-de-cubo" class="sidebar-link">Mapas de Cubo</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#shaders-de-computacion" class="sidebar-link">Shaders de Computación</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#el-shader-de-computacion" class="sidebar-link">El shader de computación</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#cielo-skybox" class="sidebar-link">Cielo (Skybox)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#reflejos" class="sidebar-link">Reflejos</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#¿la-salida-demasiado-oscura-en-webgpu" class="sidebar-link">¿La salida demasiado oscura en WebGPU?</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/#demo" class="sidebar-link">Demo</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Compute Pipelines</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Noticias</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="renderizado-de-alto-rango-dinamico"><a href="#renderizado-de-alto-rango-dinamico" class="header-anchor">#</a> Renderizado de Alto Rango Dinámico</h1> <p>Hasta este punto, hemos estado usando el espacio de color sRGB para renderizar nuestra escena. Si bien esto está bien, limita lo que podemos hacer con nuestro sistema de iluminación. Estamos usando <code>TextureFormat::Bgra8UnormSrgb</code> (en la mayoría de los sistemas) para nuestra textura de superficie. Esto significa que tenemos 8 bits para cada canal de rojo, verde, azul y alfa. Si bien los canales se almacenan como números enteros entre 0 y 255 inclusive, se convierten a y desde valores de punto flotante entre 0.0 y 1.0. El resumen es que usando texturas de 8 bits, solo obtenemos 256 valores posibles en cada canal.</p> <p>El problema con esto es que la mayoría de la precisión se utiliza para representar valores más oscuros de la escena. Esto significa que objetos brillantes como bombillas tienen el mismo valor que objetos extremadamente brillantes como el sol. Esta inexactitud hace que la iluminación realista sea difícil de hacer correctamente. Por esta razón, vamos a cambiar nuestro sistema de renderizado para usar alto rango dinámico para dar a nuestra escena más flexibilidad y permitirnos aprovechar técnicas más avanzadas como Renderizado Basado en Física.</p> <h2 id="¿que-es-el-alto-rango-dinamico"><a href="#¿que-es-el-alto-rango-dinamico" class="header-anchor">#</a> ¿Qué es el Alto Rango Dinámico?</h2> <p>En términos simples, una textura de Alto Rango Dinámico es una textura con más bits por píxel. Además de esto, las texturas HDR se almacenan como valores de punto flotante en lugar de valores enteros. Esto significa que la textura puede tener valores de brillo mayores a 1.0, lo que significa que puedes tener un rango dinámico de objetos más brillantes.</p> <h2 id="cambio-a-hdr"><a href="#cambio-a-hdr" class="header-anchor">#</a> Cambio a HDR</h2> <p>En el momento de escribir esto, wgpu no nos permite usar un formato de punto flotante como <code>TextureFormat::Rgba16Float</code> como formato de textura de superficie (no todos los monitores lo soportan de todas formas), así que tendremos que renderizar nuestra escena en un formato HDR y luego convertir los valores a un formato soportado, como <code>TextureFormat::Bgra8UnormSrgb</code> usando una técnica llamada mapeo de tonos.</p> <div class="note"><p>Hay algunas conversaciones sobre la implementación de soporte de textura de superficie HDR en wgpu. Aquí hay un problema de GitHub si deseas contribuir a ese esfuerzo: https://github.com/gfx-rs/wgpu/issues/2920</p></div> <p>Antes de hacer eso, sin embargo, necesitamos cambiar a usar una textura HDR para renderizar.</p> <p>Para empezar, crearemos un archivo llamado <code>hdr.rs</code> y colocaremos algo de código en él:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token punctuation">{</span>create_render_pipeline<span class="token punctuation">,</span> texture<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// Owns the render texture and controls tonemapping</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">HdrPipeline</span> <span class="token punctuation">{</span>
    pipeline<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span><span class="token punctuation">,</span>
    bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    texture<span class="token punctuation">:</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">,</span>
    width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayout</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">HdrPipeline</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span> config<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> width <span class="token operator">=</span> config<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">let</span> height <span class="token operator">=</span> config<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

        <span class="token comment">// We could use `Rgba32Float`, but that requires some extra</span>
        <span class="token comment">// features to be enabled for rendering.</span>
        <span class="token keyword">let</span> format <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba16Float</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> texture <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">create_2d_texture</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::texture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token comment">// This is the HDR texture</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Texture</span> <span class="token punctuation">{</span>
                        sample_type<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureSampleType</span><span class="token punctuation">::</span><span class="token class-name">Float</span> <span class="token punctuation">{</span> filterable<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
                        multisampled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerBindingType</span><span class="token punctuation">::</span><span class="token class-name">Filtering</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>layout<span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// We'll cover the shader next</span>
        <span class="token keyword">let</span> shader <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_wgsl!</span><span class="token punctuation">(</span><span class="token string">&quot;hdr.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
            push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">create_render_pipeline</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>pipeline_layout<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">add_srgb_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token comment">// We'll use some math to generate the vertex data in</span>
            <span class="token comment">// the shader, so we don't need any vertex buffers</span>
            <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">::</span><span class="token class-name">TriangleList</span><span class="token punctuation">,</span>
            shader<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">,</span>
            bind_group<span class="token punctuation">,</span>
            layout<span class="token punctuation">,</span>
            texture<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Resize the HDR texture</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>texture <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">create_2d_texture</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba16Float</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::texture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>layout<span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Exposes the HDR texture</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture<span class="token punctuation">.</span>view
    <span class="token punctuation">}</span>

    <span class="token comment">/// The format of the HDR texture</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">format</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>format
    <span class="token punctuation">}</span>

    <span class="token comment">/// This renders the internal HDR texture to the [TextureView]</span>
    <span class="token comment">/// supplied as parameter.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> encoder<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CommandEncoder</span><span class="token punctuation">,</span> output<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
                view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>output<span class="token punctuation">,</span>
                resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                ops<span class="token punctuation">:</span> <span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                    load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Load</span><span class="token punctuation">,</span>
                    store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Quizás hayas notado que agregamos un nuevo parámetro a <code>create_render_pipeline</code>. Aquí están los cambios a esa función:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">create_render_pipeline</span><span class="token punctuation">(</span>
    device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayout</span><span class="token punctuation">,</span>
    color_format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    depth_format<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    vertex_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    topology<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    shader<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderModuleDescriptor</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shader <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        primitive<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveState</span> <span class="token punctuation">{</span>
            topology<span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="mapeo-de-tonos"><a href="#mapeo-de-tonos" class="header-anchor">#</a> Mapeo de Tonos</h2> <p>El proceso de mapeo de tonos es tomar una imagen HDR y convertirla a un Rango Dinámico Estándar (SDR), que generalmente es sRGB. La curva exacta de mapeo de tonos que uses depende en última instancia de tus necesidades artísticas, pero para este tutorial, usaremos una popular conocida como el Sistema de Codificación de Color de la Academia o ACES utilizado en toda la industria de videojuegos y la industria cinematográfica.</p> <p>Con eso, saltemos al shader. Crea un archivo llamado <code>hdr.wgsl</code> y agrega el siguiente código:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token comment">// Maps HDR values to linear values</span>
<span class="token comment">// Based on http://www.oscars.org/science-technology/sci-tech-projects/aces</span>
<span class="token keyword">fn</span> <span class="token functions function">aces_tone_map</span><span class="token punctuation">(</span>hdr<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> m1 <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">(</span>
        <span class="token decimal-float-literal number">0.59719</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.07600</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.02840</span><span class="token punctuation">,</span>
        <span class="token decimal-float-literal number">0.35458</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.90834</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.13383</span><span class="token punctuation">,</span>
        <span class="token decimal-float-literal number">0.04823</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.01566</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.83777</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> m2 <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">(</span>
        <span class="token decimal-float-literal number">1.60475</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.10208</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.00327</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token decimal-float-literal number">0.53108</span><span class="token punctuation">,</span>  <span class="token decimal-float-literal number">1.10813</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.07276</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token decimal-float-literal number">0.07367</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.00605</span><span class="token punctuation">,</span>  <span class="token decimal-float-literal number">1.07602</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> m1 <span class="token operator">*</span> hdr<span class="token punctuation">;</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span>v <span class="token operator">+</span> <span class="token decimal-float-literal number">0.0245786</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">0.000090537</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token decimal-float-literal number">0.983729</span> <span class="token operator">*</span> v <span class="token operator">+</span> <span class="token decimal-float-literal number">0.4329510</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token decimal-float-literal number">0.238081</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token builtin">clamp</span><span class="token punctuation">(</span>m2 <span class="token operator">*</span> <span class="token punctuation">(</span>a <span class="token operator">/</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> uv<span class="token punctuation">:</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">vertex_index</span><span class="token punctuation">)</span></span> vi<span class="token punctuation">:</span> <span class="token builtin">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    <span class="token comment">// Generate a triangle that covers the whole screen</span>
    out<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        <span class="token builtin">f32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vi <span class="token operator">&lt;&lt;</span> <span class="token int-literal number">1u</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token int-literal number">2u</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">f32</span><span class="token punctuation">(</span>vi <span class="token operator">&amp;</span> <span class="token int-literal number">2u</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>uv <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We need to invert the y coordinate so the image</span>
    <span class="token comment">// is not upside down</span>
    out<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token decimal-float-literal number">1.0</span> <span class="token operator">-</span> out<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> hdr_image<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> hdr_sampler<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_main</span><span class="token punctuation">(</span>vs<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hdr <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>hdr_image<span class="token punctuation">,</span> hdr_sampler<span class="token punctuation">,</span> vs<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sdr <span class="token operator">=</span> <span class="token function-calls function">aces_tone_map</span><span class="token punctuation">(</span>hdr<span class="token punctuation">.</span>rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>sdr<span class="token punctuation">,</span> hdr<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Con eso en su lugar, podemos empezar a usar nuestra textura HDR en nuestra tubería de renderizado principal. Primero, necesitamos agregar el nuevo <code>HdrPipeline</code> a <code>State</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// lib.rs</span>

<span class="token keyword">mod</span> <span class="token module-declaration namespace">hdr</span><span class="token punctuation">;</span> <span class="token comment">// NUEVO!</span>

<span class="token comment">// ...</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NUEVO!</span>
    hdr<span class="token punctuation">:</span> <span class="token namespace">hdr<span class="token punctuation">::</span></span><span class="token class-name">HdrPipeline</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// NUEVO!</span>
        <span class="token keyword">let</span> hdr <span class="token operator">=</span> <span class="token namespace">hdr<span class="token punctuation">::</span></span><span class="token class-name">HdrPipeline</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            hdr<span class="token punctuation">,</span> <span class="token comment">// NUEVO!</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Luego, cuando cambiamos el tamaño de la ventana, necesitamos llamar a <code>resize()</code> en nuestro <code>HdrPipeline</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ACTUALIZADO!</span>
    <span class="token keyword">if</span> width <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> height <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>hdr
            <span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">,</span> new_size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> new_size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>A continuación, en <code>render()</code>, necesitamos cambiar el <code>RenderPass</code> para usar nuestra textura HDR en lugar de la textura de superficie:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// render()</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> render_pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
        view<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// ACTUALIZADO!</span>
        resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
            load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
                g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
                a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finalmente, después de dibujar todos los objetos en el fotograma, podemos ejecutar nuestro mapeador de tonos con la textura de superficie como salida:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NUEVO!</span>
<span class="token comment">// Aplicar mapeo de tonos</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> encoder<span class="token punctuation">,</span> <span class="token operator">&amp;</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Es un cambio bastante fácil. Aquí está la imagen antes de usar HDR:</p> <p><img src="/learn-wgpu-es/assets/img/before-hdr.18896278.png" alt="before hdr"></p> <p>Así es como se ve después de implementar HDR:</p> <p><img src="/learn-wgpu-es/assets/img/after-hdr.81564a1d.png" alt="after hdr"></p> <h2 id="cargando-texturas-hdr"><a href="#cargando-texturas-hdr" class="header-anchor">#</a> Cargando texturas HDR</h2> <p>Ahora que tenemos un búfer de renderizado HDR, podemos comenzar a aprovechar las texturas HDR al máximo. Uno de los usos principales de las texturas HDR es almacenar información de iluminación en forma de mapa de ambiente.</p> <p>Este mapa se puede usar para iluminar objetos, mostrar reflejos y también para hacer un cielo. Vamos a crear un cielo usando textura HDR, pero primero, necesitamos hablar sobre cómo se almacenan los mapas de ambiente.</p> <h2 id="texturas-equirectangulares"><a href="#texturas-equirectangulares" class="header-anchor">#</a> Texturas Equirectangulares</h2> <p>Una textura equirectangular es una textura donde una esfera se estira en una superficie rectangular usando lo que se conoce como proyección equirectangular. Este mapa de la Tierra es un ejemplo de esta proyección.</p> <p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Equirectangular_projection_SW.jpg/1024px-Equirectangular_projection_SW.jpg" alt="map of the earth"></p> <p>Esta proyección asigna los valores de longitud de la esfera a las coordenadas horizontales de la textura. Los valores de latitud se asignan a las coordenadas verticales. Esto significa que el medio vertical de la textura es el ecuador (latitud 0°) de la esfera, el medio horizontal es el meridiano principal (longitud 0°) de la esfera, los bordes izquierdo y derecho de la textura son el antimeridiano (longitud +180°/-180°) y los bordes superior e inferior de la textura son el polo norte (latitud 90°) y el polo sur (latitud -90°), respectivamente.</p> <p><img src="/learn-wgpu-es/assets/img/equirectangular.c308e566.svg" alt="equirectangular diagram"></p> <p>Esta proyección simple es fácil de usar, lo que la hace una de las proyecciones más populares para almacenar texturas esféricas. Puedes ver el mapa de ambiente particular que vamos a usar a continuación.</p> <p><img src="/learn-wgpu-es/assets/img/kloofendal_43d_clear_puresky.d293e891.jpg" alt="equirectangular skybox"></p> <h2 id="mapas-de-cubo"><a href="#mapas-de-cubo" class="header-anchor">#</a> Mapas de Cubo</h2> <p>Si bien técnicamente podemos usar un mapa equirectangular directamente, siempre que hagamos las matemáticas para determinar las coordenadas correctas, es mucho más conveniente convertir nuestro mapa de ambiente en un mapa de cubo.</p> <div class="info"><p>Un mapa de cubo es un tipo especial de textura que tiene seis capas. Cada capa corresponde a una cara diferente de un cubo imaginario alineado con los ejes X, Y y Z. Las capas se almacenan en el siguiente orden: +X, -X, +Y, -Y, +Z, -Z.</p></div> <p>Para prepararnos para almacenar la textura del cubo, vamos a crear una nueva estructura llamada <code>CubeTexture</code> en <code>texture.rs</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CubeTexture</span> <span class="token punctuation">{</span>
    texture<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">,</span>
    sampler<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Sampler</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">CubeTexture</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_2d</span><span class="token punctuation">(</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
        width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
        mip_level_count<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">,</span>
        mag_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> texture <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_texture</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            size<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Extent3d</span> <span class="token punctuation">{</span>
                width<span class="token punctuation">,</span>
                height<span class="token punctuation">,</span>
                <span class="token comment">// A cube has 6 sides, so we need 6 layers</span>
                depth_or_array_layers<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            mip_level_count<span class="token punctuation">,</span>
            sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
            usage<span class="token punctuation">,</span>
            view_formats<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> view <span class="token operator">=</span> texture<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            dimension<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">Cube</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            array_layer_count<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> sampler <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            address_mode_u<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
            address_mode_v<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
            address_mode_w<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
            mag_filter<span class="token punctuation">,</span>
            min_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            mipmap_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            texture<span class="token punctuation">,</span>
            sampler<span class="token punctuation">,</span>
            view<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">texture</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Texture</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture <span class="token punctuation">}</span>
    
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>view <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Sampler</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>sampler <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>Con esto, ahora podemos escribir el código para cargar el HDR en una textura de cubo.</p> <h2 id="shaders-de-computacion"><a href="#shaders-de-computacion" class="header-anchor">#</a> Shaders de Computación</h2> <p>Hasta este punto, hemos estado usando exclusivamente tuberías de renderizado, pero sentí que era un buen momento para introducir las tuberías de computación y, por extensión, los shaders de computación. Las tuberías de computación son mucho más fáciles de configurar. Todo lo que necesitas es decirle a la tubería qué recursos deseas usar, qué código deseas ejecutar y cuántos hilos te gustaría que la GPU use al ejecutar tu código. Vamos a usar un shader de computación para dar a cada píxel en nuestra textura de cubo un color de la imagen HDR.</p> <p>Antes de que podamos usar shaders de computación, necesitamos habilitarlos en wgpu. Podemos hacerlo cambiando la línea donde especificamos qué características queremos usar. En <code>lib.rs</code>, cambia el código donde solicitamos un dispositivo:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">)</span> <span class="token operator">=</span> adapter
    <span class="token punctuation">.</span><span class="token function">request_device</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DeviceDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token comment">// UPDATED!</span>
            features<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Features</span><span class="token punctuation">::</span><span class="token function">all_webgpu_mask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// UPDATED!</span>
            required_limits<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Limits</span><span class="token punctuation">::</span><span class="token function">downlevel_defaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token comment">// Trace path</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warn"><p>Quizás hayas notado que hemos cambiado de <code>downlevel_webgl2_defaults()</code> a <code>downlevel_defaults()</code>. Esto significa que estamos eliminando el soporte para WebGL2. La razón es que WebGL2 no admite shaders de computación. WebGPU fue construido teniendo en cuenta los shaders de computación. En el momento de escribir esto, el único navegador que soporta WebGPU es Chrome y algunos navegadores experimentales como Firefox Nightly.</p> <p>Por consiguiente, vamos a eliminar la característica de WebGL de <code>Cargo.toml</code>. Esta línea en particular:</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token key property">wgpu</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;27.0.0&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div></div> <p>Ahora que le hemos dicho a wgpu que queremos usar shaders de computación, vamos a crear una estructura en <code>resource.rs</code> que usaremos para cargar la imagen HDR en nuestro mapa de cubo.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">HdrLoader</span> <span class="token punctuation">{</span>
    texture_format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    equirect_layout<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayout</span><span class="token punctuation">,</span>
    equirect_to_cubemap<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ComputePipeline</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">HdrLoader</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> module <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_wgsl!</span><span class="token punctuation">(</span><span class="token string">&quot;equirectangular.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> texture_format <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba32Float</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> equirect_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;HdrLoader::equirect_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">COMPUTE</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Texture</span> <span class="token punctuation">{</span>
                        sample_type<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureSampleType</span><span class="token punctuation">::</span><span class="token class-name">Float</span> <span class="token punctuation">{</span> filterable<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
                        multisampled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">COMPUTE</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">StorageTexture</span> <span class="token punctuation">{</span>
                        access<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StorageTextureAccess</span><span class="token punctuation">::</span><span class="token class-name">WriteOnly</span><span class="token punctuation">,</span>
                        format<span class="token punctuation">:</span> texture_format<span class="token punctuation">,</span>
                        view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">D2Array</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>equirect_layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
            push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> equirect_to_cubemap <span class="token operator">=</span>
            device<span class="token punctuation">.</span><span class="token function">create_compute_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ComputePipelineDescriptor</span> <span class="token punctuation">{</span>
                label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;equirect_to_cubemap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                layout<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pipeline_layout<span class="token punctuation">)</span><span class="token punctuation">,</span>
                module<span class="token punctuation">:</span> <span class="token operator">&amp;</span>module<span class="token punctuation">,</span>
                entry_point<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;compute_equirect_to_cubemap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                compilation_options<span class="token punctuation">:</span> <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                cache<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            equirect_to_cubemap<span class="token punctuation">,</span>
            texture_format<span class="token punctuation">,</span>
            equirect_layout<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_equirectangular_bytes</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        dst_size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">CubeTexture</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> hdr_decoder <span class="token operator">=</span> <span class="token class-name">HdrDecoder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cursor</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> meta <span class="token operator">=</span> hdr_decoder<span class="token punctuation">.</span><span class="token function">metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token attribute attr-name">#[cfg(not(target_arch=<span class="token string">&quot;wasm32&quot;</span>))]</span>
        <span class="token keyword">let</span> pixels <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> pixels <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> meta<span class="token punctuation">.</span>width <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token operator">*</span> meta<span class="token punctuation">.</span>height <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            hdr_decoder<span class="token punctuation">.</span><span class="token function">read_image_transform</span><span class="token punctuation">(</span>
                <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>pix<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> rgb <span class="token operator">=</span> pix<span class="token punctuation">.</span><span class="token function">to_hdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">[</span>rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0f32</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span><span class="token keyword">mut</span> pixels<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            pixels
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token attribute attr-name">#[cfg(target_arch=<span class="token string">&quot;wasm32&quot;</span>)]</span>
        <span class="token keyword">let</span> pixels <span class="token operator">=</span> hdr_decoder<span class="token punctuation">.</span><span class="token function">read_image_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span>
            <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>pix<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> rgb <span class="token operator">=</span> pix<span class="token punctuation">.</span><span class="token function">to_hdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span>rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0f32</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> src <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">create_2d_texture</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            meta<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
            meta<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>texture_format<span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">COPY_DST</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Linear</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        queue<span class="token punctuation">.</span><span class="token function">write_texture</span><span class="token punctuation">(</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TexelCopyTextureInfo</span> <span class="token punctuation">{</span>
                texture<span class="token punctuation">:</span> <span class="token operator">&amp;</span>src<span class="token punctuation">.</span>texture<span class="token punctuation">,</span>
                mip_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                origin<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Origin3d</span><span class="token punctuation">::</span><span class="token constant">ZERO</span><span class="token punctuation">,</span>
                aspect<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureAspect</span><span class="token punctuation">::</span><span class="token class-name">All</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pixels<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TexelCopyBufferLayout</span> <span class="token punctuation">{</span>
                offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                bytes_per_row<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                rows_per_image<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            src<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> dst <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">CubeTexture</span><span class="token punctuation">::</span><span class="token function">create_2d</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            dst_size<span class="token punctuation">,</span>
            dst_size<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>texture_format<span class="token punctuation">,</span>
            <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token comment">// We are going to write to `dst` texture so we</span>
            <span class="token comment">// need to use a `STORAGE_BINDING`.</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">STORAGE_BINDING</span>
                <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            label<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> dst_view <span class="token operator">=</span> dst<span class="token punctuation">.</span><span class="token function">texture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            <span class="token comment">// Normally, you'd use `TextureViewDimension::Cube`</span>
            <span class="token comment">// for a cube texture, but we can't use that</span>
            <span class="token comment">// view dimension with a `STORAGE_BINDING`.</span>
            <span class="token comment">// We need to access the cube texture layers</span>
            <span class="token comment">// directly.</span>
            dimension<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">D2Array</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>equirect_layout<span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_compute_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ComputePassDescriptor</span> <span class="token punctuation">{</span> label <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> num_workgroups <span class="token operator">=</span> <span class="token punctuation">(</span>dst_size <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>equirect_to_cubemap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">dispatch_workgroups</span><span class="token punctuation">(</span>num_workgroups<span class="token punctuation">,</span> num_workgroups<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">drop</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">[</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>La llamada <code>dispatch_workgroups</code> le dice a la GPU que ejecute nuestro código en lotes llamados grupos de trabajo. Cada grupo de trabajo tiene un número de hilos de trabajo llamados invocaciones que ejecutan el código en paralelo. Los grupos de trabajo se organizan como una cuadrícula 3D con las dimensiones que pasamos a <code>dispatch_workgroups</code>.</p> <p>En este ejemplo, tenemos una cuadrícula de grupos de trabajo dividida en fragmentos de 16x16 y almacenando la capa en la dimensión z.</p> <h2 id="el-shader-de-computacion"><a href="#el-shader-de-computacion" class="header-anchor">#</a> El shader de computación</h2> <p>Ahora, escribamos un shader de computación que convertirá nuestra textura equirectangular a una textura de cubo. Crea un archivo llamado <code>equirectangular.wgsl</code>. Vamos a desglosarlo fragmento por fragmento.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">const</span> <span class="token class-name">PI</span><span class="token punctuation">:</span> <span class="token builtin">f32</span> <span class="token operator">=</span> <span class="token decimal-float-literal number">3.1415926535897932384626433832795</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Face</span> <span class="token punctuation">{</span>
    forward<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    up<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    right<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dos cosas aquí:</p> <ol><li>WGSL no tiene una función integrada para PI, así que necesitamos especificarlo nosotros mismos.</li> <li>Cada cara del mapa de cubo tiene una orientación, así que necesitamos almacenarla.</li></ol> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> src<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> dst<span class="token punctuation">:</span> <span class="token builtin">texture_storage_2d_array</span><span class="token punctuation">&lt;</span>rgba32float<span class="token punctuation">,</span> write<span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>Aquí, tenemos los únicos dos enlaces que necesitamos. La textura equirectangular <code>src</code> y nuestra textura de cubo <code>dst</code>. Algunas cosas a tener en cuenta sobre <code>dst</code>:</p> <ol><li>Aunque <code>dst</code> es una textura de cubo, se almacena como una matriz de texturas 2D.</li> <li>El tipo de enlace que estamos usando aquí es una textura de almacenamiento. Una textura de almacenamiento de matriz, para ser precisos. Este es un enlace único solo disponible para shaders de computación. Nos permite escribir directamente en la textura.</li> <li>Cuando usamos un enlace de textura de almacenamiento, necesitamos especificar el formato de la textura. Si intentas vincular una textura con un formato diferente, wgpu entrará en pánico.</li></ol> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">compute</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">workgroup_size</span><span class="token punctuation">(</span><span class="token int-literal number">16</span><span class="token punctuation">,</span> <span class="token int-literal number">16</span><span class="token punctuation">,</span> <span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">fn</span> <span class="token functions function">compute_equirect_to_cubemap</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">global_invocation_id</span><span class="token punctuation">)</span></span>
    gid<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">u32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If texture size is not divisible by 32, we</span>
    <span class="token comment">// need to make sure we don't try to write to</span>
    <span class="token comment">// pixels that don't exist.</span>
    <span class="token keyword">if</span> gid<span class="token punctuation">.</span>x <span class="token operator">&gt;=</span> <span class="token builtin">u32</span><span class="token punctuation">(</span><span class="token builtin">textureDimensions</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> <span class="token class-name">FACES</span><span class="token punctuation">:</span> <span class="token builtin">array</span><span class="token punctuation">&lt;</span><span class="token class-name">Face</span><span class="token punctuation">,</span> <span class="token int-literal number">6</span><span class="token punctuation">&gt;</span> <span class="token operator">=</span> <span class="token builtin">array</span><span class="token punctuation">(</span>
        <span class="token comment">// FACES +X</span>
        <span class="token function-calls function">Face</span><span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// forward</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// up</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// right</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES -X</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES +Y</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES -Y</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES +Z</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES -Z</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get texture coords relative to cubemap face</span>
    <span class="token keyword">let</span> dst_dimensions <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span><span class="token builtin">textureDimensions</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> cube_uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>gid<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> dst_dimensions <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">;</span>

    <span class="token comment">// Get spherical coordinate from cube_uv</span>
    <span class="token keyword">let</span> face <span class="token operator">=</span> <span class="token class-name">FACES</span><span class="token punctuation">[</span>gid<span class="token punctuation">.</span>z<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> spherical <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>face<span class="token punctuation">.</span>forward <span class="token operator">+</span> face<span class="token punctuation">.</span>right <span class="token operator">*</span> cube_uv<span class="token punctuation">.</span>x <span class="token operator">+</span> face<span class="token punctuation">.</span>up <span class="token operator">*</span> cube_uv<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get coordinate on the equirectangular texture</span>
    <span class="token keyword">let</span> inv_atan <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.1591</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.3183</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> eq_uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">(</span><span class="token builtin">atan2</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>z<span class="token punctuation">,</span> spherical<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">asin</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> inv_atan <span class="token operator">+</span> <span class="token decimal-float-literal number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> eq_pixel <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">i32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>eq_uv <span class="token operator">*</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span><span class="token builtin">textureDimensions</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We use textureLoad() as textureSample() is not allowed in compute shaders</span>
    <span class="token keyword">var</span> sample <span class="token operator">=</span> <span class="token builtin">textureLoad</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> eq_pixel<span class="token punctuation">,</span> <span class="token int-literal number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">textureStore</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> gid<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> gid<span class="token punctuation">.</span>z<span class="token punctuation">,</span> sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Aunque comenté el código anterior, hay algunas cosas que quiero repasar que no se ajustarían bien en un comentario.</p> <p>El decorador <code>workgroup_size</code> indica las dimensiones de la cuadrícula local de invocaciones del grupo de trabajo. Debido a que estamos enviando un grupo de trabajo para cada píxel en la textura, hacemos que cada grupo de trabajo sea una cuadrícula de 16x16x1. Esto significa que cada grupo de trabajo puede tener 256 hilos con los que trabajar.</p> <div class="warn"><p>Para WebGPU, cada grupo de trabajo puede tener un máximo de 256 hilos (también llamados invocaciones).</p></div> <p>Con esto, podemos cargar el mapa de ambiente en la función <code>new()</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> hdr_loader <span class="token operator">=</span> <span class="token namespace">resources<span class="token punctuation">::</span></span><span class="token class-name">HdrLoader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sky_bytes <span class="token operator">=</span> <span class="token namespace">resources<span class="token punctuation">::</span></span><span class="token function">load_binary</span><span class="token punctuation">(</span><span class="token string">&quot;pure-sky.hdr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sky_texture <span class="token operator">=</span> hdr_loader<span class="token punctuation">.</span><span class="token function">from_equirectangular_bytes</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>device<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>queue<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>sky_bytes<span class="token punctuation">,</span>
    <span class="token number">1080</span><span class="token punctuation">,</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Sky Texture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="cielo-skybox"><a href="#cielo-skybox" class="header-anchor">#</a> Cielo (Skybox)</h2> <p>Ahora que tenemos un mapa de ambiente para renderizar, usémoslo para hacer nuestro cielo. Hay diferentes formas de renderizar un cielo. Una forma estándar es renderizar un cubo y mapear el mapa de ambiente en él. Si bien ese método funciona, puede tener algunos artefactos en las esquinas y bordes donde se encuentran las caras del cubo.</p> <p>En cambio, vamos a renderizar en toda la pantalla, calcular la dirección de vista de cada píxel y usarla para muestrear la textura. Primero, necesitamos crear un grupo de enlace para el mapa de ambiente para que podamos usarlo para renderizar. Agrega lo siguiente a <code>new()</code>:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> environment_layout <span class="token operator">=</span>
    device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;environment_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Texture</span> <span class="token punctuation">{</span>
                    sample_type<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureSampleType</span><span class="token punctuation">::</span><span class="token class-name">Float</span> <span class="token punctuation">{</span> filterable<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">Cube</span><span class="token punctuation">,</span>
                    multisampled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerBindingType</span><span class="token punctuation">::</span><span class="token class-name">NonFiltering</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> environment_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;environment_bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>environment_layout<span class="token punctuation">,</span>
    entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sky_texture<span class="token punctuation">.</span><span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span>sky_texture<span class="token punctuation">.</span><span class="token function">sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Ahora que tenemos el grupo de enlace, necesitamos una tubería de renderizado para renderizar el cielo.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NUEVO!</span>
<span class="token keyword">let</span> sky_pipeline <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Sky Pipeline Layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>camera_bind_group_layout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>environment_layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
        push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> shader <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_wgsl!</span><span class="token punctuation">(</span><span class="token string">&quot;sky.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">create_render_pipeline</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>device<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>layout<span class="token punctuation">,</span>
        hdr<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token constant">DEPTH_FORMAT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">::</span><span class="token class-name">TriangleList</span><span class="token punctuation">,</span>
        shader<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Una cosa a tener en cuenta aquí. Agregamos el formato primitivo a <code>create_render_pipeline()</code>. Además, cambiamos la función de comparación de profundidad a <code>CompareFunction::LessEqual</code> (discutiremos por qué cuando repasemos el shader del cielo). Aquí están los cambios en eso:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">create_render_pipeline</span><span class="token punctuation">(</span>
    device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayout</span><span class="token punctuation">,</span>
    color_format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    depth_format<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    vertex_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    topology<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    shader<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderModuleDescriptor</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shader <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        primitive<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveState</span> <span class="token punctuation">{</span>
            topology<span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        depth_stencil<span class="token punctuation">:</span> depth_format<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>format<span class="token closure-punctuation punctuation">|</span></span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthStencilState</span> <span class="token punctuation">{</span>
            format<span class="token punctuation">,</span>
            depth_write_enabled<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            depth_compare<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CompareFunction</span><span class="token punctuation">::</span><span class="token class-name">LessEqual</span><span class="token punctuation">,</span> <span class="token comment">// UDPATED!</span>
            stencil<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilState</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bias<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthBiasState</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>No olvides agregar el nuevo grupo de enlace y tubería a <code>State</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NUEVO!</span>
    hdr<span class="token punctuation">:</span> <span class="token namespace">hdr<span class="token punctuation">::</span></span><span class="token class-name">HdrPipeline</span><span class="token punctuation">,</span>
    environment_bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    sky_pipeline<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Window</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">State</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token comment">// NUEVO!</span>
            hdr<span class="token punctuation">,</span>
            environment_bind_group<span class="token punctuation">,</span>
            sky_pipeline<span class="token punctuation">,</span>
            debug<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Ahora cubramos <code>sky.wgsl</code>.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
    view_pos<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_map<span class="token punctuation">:</span> <span class="token builtin">texture_cube</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_sampler<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> frag_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">vertex_index</span><span class="token punctuation">)</span></span> id<span class="token punctuation">:</span> <span class="token builtin">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span><span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">u32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        id <span class="token operator">&amp;</span> <span class="token int-literal number">1u</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token int-literal number">1u</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token int-literal number">1u</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    <span class="token comment">// out.clip_position = vec4(uv * vec2(4.0, -4.0) + vec2(-1.0, 1.0), 0.0, 1.0);</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>uv <span class="token operator">*</span> <span class="token decimal-float-literal number">4.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>frag_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>uv <span class="token operator">*</span> <span class="token decimal-float-literal number">4.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_main</span><span class="token punctuation">(</span>in<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> view_pos_homogeneous <span class="token operator">=</span> camera<span class="token punctuation">.</span>inv_proj <span class="token operator">*</span> in<span class="token punctuation">.</span>clip_position<span class="token punctuation">;</span>
    <span class="token keyword">let</span> view_ray_direction <span class="token operator">=</span> view_pos_homogeneous<span class="token punctuation">.</span>xyz <span class="token operator">/</span> view_pos_homogeneous<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
    <span class="token keyword">var</span> ray_direction <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>inv_view <span class="token operator">*</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>view_ray_direction<span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> sample <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>env_map<span class="token punctuation">,</span> env_sampler<span class="token punctuation">,</span> ray_direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sample<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Desglosemos esto:</p> <ol><li>Creamos un triángulo del doble del tamaño de la pantalla.</li> <li>En el shader de fragmento, obtenemos la dirección de vista de la posición de clip. Usamos la matriz de proyección inversa para convertir las coordenadas de clip a dirección de vista. Luego, usamos la matriz de vista inversa para obtener la dirección en el espacio mundial, ya que eso es lo que necesitamos para muestrear el cielo correctamente.</li> <li>Luego muestreamos la textura del cielo con la dirección de vista.</li></ol> <p>Para que esto funcione, necesitamos cambiar un poco nuestros uniformes de cámara. Necesitamos agregar la matriz de vista inversa y la matriz de proyección inversa a la estructura <code>CameraUniform</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">CameraUniform</span> <span class="token punctuation">{</span>
    view_position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    view_proj<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    inv_view<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">CameraUniform</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            view_position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            view<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            view_proj<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inv_proj<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            inv_view<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// UPDATED!</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> camera<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">camera<span class="token punctuation">::</span></span><span class="token class-name">Camera</span><span class="token punctuation">,</span> projection<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">camera<span class="token punctuation">::</span></span><span class="token class-name">Projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">to_homogeneous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> proj <span class="token operator">=</span> projection<span class="token punctuation">.</span><span class="token function">calc_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> view <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">calc_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> view_proj <span class="token operator">=</span> proj <span class="token operator">*</span> view<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view_proj <span class="token operator">=</span> view_proj<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inv_proj <span class="token operator">=</span> proj<span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inv_view <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Asegúrate de cambiar la definición de <code>Camera</code> en <code>shader.wgsl</code> y <code>light.wgsl</code>. Como recordatorio, se ve así:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
    view_pos<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">;</span>
</code></pre></div><div class="info"><p>Quizás hayas notado que quitamos la <code>OPENGL_TO_WGPU_MATRIX</code>. La razón es que estaba interfiriendo con la proyección del cielo.</p> <p><img src="/learn-wgpu-es/assets/img/project-error.00a25de7.png" alt="projection error"></p> <p>Técnicamente, no era necesaria, así que me pareció bien eliminarla.</p></div> <h2 id="reflejos"><a href="#reflejos" class="header-anchor">#</a> Reflejos</h2> <p>Ahora que tenemos un cielo, podemos experimentar usándolo para iluminación. Esto no será físicamente preciso (lo veremos más adelante). Dicho esto, tenemos el mapa de ambiente, así que también podemos usarlo.</p> <p>Para hacer eso, sin embargo, necesitamos cambiar nuestro shader para hacer iluminación en el espacio mundial en lugar de espacio tangente porque nuestro mapa de ambiente está en el espacio mundial. Debido a que hay muchos cambios, publicaré el shader completo aquí:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token comment">// Vertex shader</span>

<span class="token keyword">struct</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
    view_pos<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Light</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    color<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> light<span class="token punctuation">:</span> <span class="token class-name">Light</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexInput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span> tex_coords<span class="token punctuation">:</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span> normal<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span> tangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">4</span><span class="token punctuation">)</span> bitangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">InstanceInput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">5</span><span class="token punctuation">)</span> model_matrix_0<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">6</span><span class="token punctuation">)</span> model_matrix_1<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">7</span><span class="token punctuation">)</span> model_matrix_2<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">8</span><span class="token punctuation">)</span> model_matrix_3<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">9</span><span class="token punctuation">)</span> normal_matrix_0<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">10</span><span class="token punctuation">)</span> normal_matrix_1<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">11</span><span class="token punctuation">)</span> normal_matrix_2<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> tex_coords<span class="token punctuation">:</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// Updated!</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span> world_position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span> world_view_position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span> world_light_position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">4</span><span class="token punctuation">)</span> world_normal<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">5</span><span class="token punctuation">)</span> world_tangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">6</span><span class="token punctuation">)</span> world_bitangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    model<span class="token punctuation">:</span> <span class="token class-name">VertexInput</span><span class="token punctuation">,</span>
    instance<span class="token punctuation">:</span> <span class="token class-name">InstanceInput</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> model_matrix <span class="token operator">=</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>model_matrix_0<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_1<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_2<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_3<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> normal_matrix <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>normal_matrix_0<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>normal_matrix_1<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>normal_matrix_2<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// UPDATED!</span>
    <span class="token keyword">let</span> world_position <span class="token operator">=</span> model_matrix <span class="token operator">*</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>position<span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>view_proj <span class="token operator">*</span> world_position<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>tex_coords <span class="token operator">=</span> model<span class="token punctuation">.</span>tex_coords<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_normal <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>normal_matrix <span class="token operator">*</span> model<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_tangent <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>normal_matrix <span class="token operator">*</span> model<span class="token punctuation">.</span>tangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_bitangent <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>normal_matrix <span class="token operator">*</span> model<span class="token punctuation">.</span>bitangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_position <span class="token operator">=</span> world_position<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_view_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>view_pos<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Fragment shader</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> t_diffuse<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span><span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> s_diffuse<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span><span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> t_normal<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> s_normal<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_map<span class="token punctuation">:</span> <span class="token builtin">texture_cube</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_sampler<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_main</span><span class="token punctuation">(</span>in<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> object_color<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>t_diffuse<span class="token punctuation">,</span> s_diffuse<span class="token punctuation">,</span> in<span class="token punctuation">.</span>tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> object_normal<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>t_normal<span class="token punctuation">,</span> s_normal<span class="token punctuation">,</span> in<span class="token punctuation">.</span>tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// NEW!</span>
    <span class="token comment">// Adjust the tangent and bitangent using the Gramm-Schmidt process</span>
    <span class="token comment">// This makes sure that they are perpendicular to each other and the</span>
    <span class="token comment">// normal of the surface.</span>
    <span class="token keyword">let</span> world_tangent <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>world_tangent <span class="token operator">-</span> <span class="token builtin">dot</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>world_tangent<span class="token punctuation">,</span> in<span class="token punctuation">.</span>world_normal<span class="token punctuation">)</span> <span class="token operator">*</span> in<span class="token punctuation">.</span>world_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> world_bitangent <span class="token operator">=</span> <span class="token builtin">cross</span><span class="token punctuation">(</span>world_tangent<span class="token punctuation">,</span> in<span class="token punctuation">.</span>world_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Convert the normal sample to world space</span>
    <span class="token keyword">let</span> <span class="token class-name">TBN</span> <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">(</span>
        world_tangent<span class="token punctuation">,</span>
        world_bitangent<span class="token punctuation">,</span>
        in<span class="token punctuation">.</span>world_normal<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tangent_normal <span class="token operator">=</span> object_normal<span class="token punctuation">.</span>xyz <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> world_normal <span class="token operator">=</span> <span class="token class-name">TBN</span> <span class="token operator">*</span> tangent_normal<span class="token punctuation">;</span>

    <span class="token comment">// Create the lighting vectors</span>
    <span class="token keyword">let</span> light_dir <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>position <span class="token operator">-</span> in<span class="token punctuation">.</span>world_position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> view_dir <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>world_view_position <span class="token operator">-</span> in<span class="token punctuation">.</span>world_position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> half_dir <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>view_dir <span class="token operator">+</span> light_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> diffuse_strength <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">dot</span><span class="token punctuation">(</span>world_normal<span class="token punctuation">,</span> light_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diffuse_color <span class="token operator">=</span> light<span class="token punctuation">.</span>color <span class="token operator">*</span> diffuse_strength<span class="token punctuation">;</span>

    <span class="token keyword">let</span> specular_strength <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">dot</span><span class="token punctuation">(</span>world_normal<span class="token punctuation">,</span> half_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> specular_color <span class="token operator">=</span> specular_strength <span class="token operator">*</span> light<span class="token punctuation">.</span>color<span class="token punctuation">;</span>

    <span class="token comment">// NEW!</span>
    <span class="token comment">// Calculate reflections</span>
    <span class="token keyword">let</span> world_reflect <span class="token operator">=</span> <span class="token builtin">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>view_dir<span class="token punctuation">,</span> world_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> reflection <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>env_map<span class="token punctuation">,</span> env_sampler<span class="token punctuation">,</span> world_reflect<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
    <span class="token keyword">let</span> shininess <span class="token operator">=</span> <span class="token decimal-float-literal number">0.1</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">(</span>diffuse_color <span class="token operator">+</span> specular_color<span class="token punctuation">)</span> <span class="token operator">*</span> object_color<span class="token punctuation">.</span>xyz <span class="token operator">+</span> reflection <span class="token operator">*</span> shininess<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> object_color<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Una pequeña nota sobre la matemática de la reflexión. El <code>view_dir</code> nos da la dirección hacia la cámara desde la superficie. La matemática de reflexión necesita la dirección desde la cámara hacia la superficie, así que negamos <code>view_dir</code>. Luego usamos la función integrada <code>reflect</code> de <code>wgsl</code> para reflejar el <code>view_dir</code> invertido sobre <code>world_normal</code>. Esto nos da una dirección que podemos usar para muestrear el mapa de ambiente y obtener el color del cielo en esa dirección. Solo mirando el componente de reflexión nos da lo siguiente:</p> <p><img src="/learn-wgpu-es/assets/img/just-reflections.e704b658.png" alt="just-reflections"></p> <p>Aquí está la escena terminada:</p> <p><img src="/learn-wgpu-es/assets/img/with-reflections.f69690db.png" alt="with-reflections"></p> <h2 id="¿la-salida-demasiado-oscura-en-webgpu"><a href="#¿la-salida-demasiado-oscura-en-webgpu" class="header-anchor">#</a> ¿La salida demasiado oscura en WebGPU?</h2> <p>WebGPU no admite el uso de formatos de textura sRGB como
la salida de una superficie. Podemos contornear esto haciendo
que la vista de textura utilizada para renderizar use la versión
sRGB del formato. Para hacer esto, necesitamos cambiar la
configuración de superficie que usamos para permitir formatos
de vista con sRGB.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span> <span class="token punctuation">{</span>
    usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
    format<span class="token punctuation">:</span> surface_format<span class="token punctuation">,</span>
    width<span class="token punctuation">:</span> size<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> size<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    present_mode<span class="token punctuation">:</span> surface_caps<span class="token punctuation">.</span>present_modes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    alpha_mode<span class="token punctuation">:</span> surface_caps<span class="token punctuation">.</span>alpha_modes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// NUEVO!</span>
    view_formats<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>surface_format<span class="token punctuation">.</span><span class="token function">add_srgb_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    desired_maximum_frame_latency<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Luego, necesitamos crear una vista con sRGB habilitado en
<code>State::render()</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> view <span class="token operator">=</span> output
    <span class="token punctuation">.</span>texture
    <span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span> <span class="token punctuation">{</span>
        format<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">add_srgb_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Quizás también hayas notado que en <code>HdrPipeline::new()</code>
usamos <code>config.format.add_srgb_suffix()</code> cuando creamos
la tubería de renderizado. Esto es obligatorio porque si no lo
hacemos, la <code>TextureView</code> habilitada para sRGB no funcionará
con la tubería de renderizado.</p> <p>Con eso deberías obtener la salida sRGB como se esperaba.</p> <h2 id="demo"><a href="#demo" class="header-anchor">#</a> Demo</h2> <div class="warn"><p>Si tu navegador no soporta WebGPU, este ejemplo no funcionará para ti.</p></div> <div id="wasm-example"><canvas id="canvas"></canvas> <!----> <!----> <!----> <button>
    Click to start Tutorial13_hdr!
  </button></div> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/intermediate/tutorial13-hdr/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Última Actualización: </span> <span class="time">12/15/2025, 10:59:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu-es/intermediate/tutorial12-camera/" class="prev">
          Una Cámara Mejor
        </a></span> <span class="next"><a href="/learn-wgpu-es/compute/introduction/">
          Introducción a los Compute Pipelines
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu-es/assets/js/app.fb31abca.js" defer></script><script src="/learn-wgpu-es/assets/js/2.1022e2be.js" defer></script><script src="/learn-wgpu-es/assets/js/1.4766453e.js" defer></script><script src="/learn-wgpu-es/assets/js/13.8eb85f08.js" defer></script><script src="/learn-wgpu-es/assets/js/23.247ad87d.js" defer></script><script src="/learn-wgpu-es/assets/js/22.5d980ee9.js" defer></script>
  </body>
</html>
