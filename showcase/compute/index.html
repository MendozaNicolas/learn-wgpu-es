<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ejemplo de Compute: Tangentes y Bitangentes | Learn Wgpu - Español</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/learn-wgpu-es/assets/css/0.styles.54a9523f.css" as="style"><link rel="preload" href="/learn-wgpu-es/assets/js/app.fb31abca.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/2.1022e2be.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/1.4766453e.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/18.d64e2c10.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/22.5d980ee9.js" as="script"><link rel="prefetch" href="/learn-wgpu-es/assets/js/10.85d1b333.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/11.3c198606.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/12.97c631a2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/13.8eb85f08.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/14.f56f5783.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/15.f146080a.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/16.b78eff55.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/17.ac1b915c.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/19.b80b7231.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/20.5525796a.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/21.d2868a6a.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/23.247ad87d.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/24.086d80a7.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/25.0ba438e3.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/26.aed3aec3.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/27.b4a1c2ae.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/28.2764cb5c.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/29.58f67d16.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/3.210ed7b2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/30.c5e766e5.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/31.5a6c1c03.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/32.b00abf9b.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/33.c2bc481b.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/34.f2bc04d8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/35.58c2c8d8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/36.d4783bfb.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/37.0f259387.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/38.3c99ab64.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/39.84e651b2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/4.db40dd96.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/40.56d1e232.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/41.f90ff503.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/42.7911692d.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/43.4f83f7e5.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/44.943c009e.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/45.0ab6ac73.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/46.c4185287.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/47.777cc2bf.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/48.96be8e13.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/49.aa04b1d6.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/5.6fdb9071.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/50.4022d2a0.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/51.3c411e45.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/52.2918a592.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/53.ee6c7c86.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/54.ec95ed52.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/55.da436f39.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/56.a7464507.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/57.38978bd1.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/58.f03403ea.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/59.d0f0d3af.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/60.675b3161.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/61.0d9a5510.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/62.cb765cf3.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/8.c8ddf2a2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/9.28f40848.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/vendors~docsearch.ccaccf87.js">
    <link rel="stylesheet" href="/learn-wgpu-es/assets/css/0.styles.54a9523f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu-es/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu - Español</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu-es/" aria-current="page" class="sidebar-link">Introducción</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Principiante</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-es/beginner/tutorial1-window/" class="sidebar-link">Dependencias y la ventana</a></li><li><a href="/learn-wgpu-es/beginner/tutorial2-surface/" class="sidebar-link">La Superficie</a></li><li><a href="/learn-wgpu-es/beginner/tutorial3-pipeline/" class="sidebar-link">El Pipeline</a></li><li><a href="/learn-wgpu-es/beginner/tutorial4-buffer/" class="sidebar-link">Búferes e Índices</a></li><li><a href="/learn-wgpu-es/beginner/tutorial5-textures/" class="sidebar-link">Texturas y grupos de enlace</a></li><li><a href="/learn-wgpu-es/beginner/tutorial6-uniforms/" class="sidebar-link">Búferes uniformes y una cámara 3D</a></li><li><a href="/learn-wgpu-es/beginner/tutorial7-instancing/" class="sidebar-link">Instanciación</a></li><li><a href="/learn-wgpu-es/beginner/tutorial8-depth/" class="sidebar-link">El Búfer de Profundidad</a></li><li><a href="/learn-wgpu-es/beginner/tutorial9-models/" class="sidebar-link">Carga de Modelos</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermedio</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-es/intermediate/tutorial10-lighting/" class="sidebar-link">Trabajando con Luces</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial11-normals/" class="sidebar-link">Mapeo de Normales</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial12-camera/" class="sidebar-link">Una Cámara Mejor</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/" class="sidebar-link">Renderizado de Alto Rango Dinámico</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Compute Pipelines</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Showcase</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-es/showcase/" aria-current="page" class="sidebar-link">Prólogo</a></li><li><a href="/learn-wgpu-es/showcase/windowless/" class="sidebar-link">Wgpu sin ventana</a></li><li><a href="/learn-wgpu-es/showcase/gifs/" class="sidebar-link">Creando GIFs</a></li><li><a href="/learn-wgpu-es/showcase/pong/" class="sidebar-link">Pong</a></li><li><a href="/learn-wgpu-es/showcase/compute/" aria-current="page" class="active sidebar-link">Ejemplo de Compute: Tangentes y Bitangentes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu-es/showcase/compute/#posibles-mejoras" class="sidebar-link">Posibles Mejoras</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/showcase/compute/#resultados" class="sidebar-link">Resultados</a></li></ul></li><li><a href="/learn-wgpu-es/showcase/alignment/" class="sidebar-link">Diseño de Memoria en WGSL</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Noticias</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ejemplo-de-compute-tangentes-y-bitangentes"><a href="#ejemplo-de-compute-tangentes-y-bitangentes" class="header-anchor">#</a> Ejemplo de Compute: Tangentes y Bitangentes</h1> <p>Esto resultó ser más difícil de lo que anticipé. El primer problema que encontré fue cierta corrupción de datos de vértices debido a que el shader estaba leyendo mis datos de vértices incorrectamente. Estaba usando la estructura <code>ModelVertex</code> que usé en el <a href="/learn-wgpu-es/intermediate/tutorial11-normals/">tutorial de mapeo de normales</a>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, Debug, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ModelVertex</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    normal<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tangent<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    bitangent<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Esta estructura funciona perfectamente cuando se usa como búfer de vértices. Usarla como búfer de almacenamiento resultó ser menos conveniente. Mi código anterior usaba una estructura GLSL similar a mi <code>ModelVertex</code>.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">struct</span> <span class="token class-name">ModelVertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> position<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> tex_coords<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> normal<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> tangent<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> bitangent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>A primera vista, esto parece estar bien, pero los expertos en OpenGL probablemente verían un problema con la estructura. Nuestros campos no están alineados correctamente para soportar la alineación <code>std430</code> que requieren los búferes de almacenamiento. No entraré en detalle, pero puedes revisar la <a href="../alignment">demostración de alineación</a> si quieres saber más. Para resumir, el <code>vec2</code> para <code>tex_coords</code> estaba arruinando la alineación de bytes, corrompiendo los datos de vértices resultando en lo siguiente:</p> <p><img src="/learn-wgpu-es/assets/img/corruption.675b1eca.png" alt="./corruption.png"></p> <p>Podría haber arreglado esto agregando un campo de relleno después de <code>tex_coords</code> en el lado de Rust, pero eso requeriría modificar el <code>VertexBufferLayout</code>. Terminé resolviendo este problema utilizando los componentes de los vectores directamente, lo que resultó en una estructura como esta:</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">struct</span> <span class="token class-name">ModelVertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">float</span> x<span class="token punctuation">;</span> <span class="token keyword">float</span> y<span class="token punctuation">;</span> <span class="token keyword">float</span> z<span class="token punctuation">;</span>
    <span class="token keyword">float</span> uv<span class="token punctuation">;</span> <span class="token keyword">float</span> uw<span class="token punctuation">;</span>
    <span class="token keyword">float</span> nx<span class="token punctuation">;</span> <span class="token keyword">float</span> ny<span class="token punctuation">;</span> <span class="token keyword">float</span> nz<span class="token punctuation">;</span>
    <span class="token keyword">float</span> tx<span class="token punctuation">;</span> <span class="token keyword">float</span> ty<span class="token punctuation">;</span> <span class="token keyword">float</span> tz<span class="token punctuation">;</span>
    <span class="token keyword">float</span> bx<span class="token punctuation">;</span> <span class="token keyword">float</span> by<span class="token punctuation">;</span> <span class="token keyword">float</span> bz<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Dado que <code>std430</code> usará la alineación del elemento más grande de la estructura, usar todos los flotantes significa que la estructura se alineará a 4 bytes. Esta alineación coincide con la que <code>ModelVertex</code> usa en Rust. Fue un poco incómodo trabajar con esto, pero arregló el problema de corrupción.</p> <p>El segundo problema me requirió replantear cómo estaba calculando la tangente y bitangente. El algoritmo anterior que estaba usando solo calculaba la tangente y bitangente para cada triángulo y configuraba todos los vértices en ese triángulo para usar la misma tangente y bitangente. Aunque esto está bien en un contexto de un solo hilo, el código se desmorona cuando se intenta calcular los triángulos en paralelo. La razón es que múltiples triángulos pueden compartir los mismos vértices. Esto significa que cuando vamos a guardar las tangentes resultantes, inevitablemente terminamos intentando escribir en el mismo vértice desde múltiples hilos diferentes, lo cual no está permitido. Puedes ver el problema con este método a continuación:</p> <p><img src="/learn-wgpu-es/assets/img/black_triangles.df338b97.png" alt="./black_triangles.png"></p> <p>Esos triángulos negros fueron el resultado de múltiples hilos de GPU intentando modificar los mismos vértices. Observando los datos en Render Doc pude ver que las tangentes y bitangentes eran números basura como <code>NaN</code>.</p> <p><img src="/learn-wgpu-es/assets/img/render_doc_output.e0c8b298.png" alt="./render_doc_output.png"></p> <p>Mientras que en la CPU podríamos introducir una primitiva de sincronización como un <code>Mutex</code> para arreglar este problema, que sepa no existe realmente algo así en la GPU. En su lugar, decidí modificar mi código para trabajar con cada vértice individualmente. Hay algunos obstáculos con eso, pero serán más fáciles de explicar en código. Comencemos con la función <code>main</code>.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint</span> vertexIndex <span class="token operator">=</span> gl_GlobalInvocationID<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    ModelVertex result <span class="token operator">=</span> <span class="token function">calcTangentBitangent</span><span class="token punctuation">(</span>vertexIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dstVertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Usamos <code>gl_GlobalInvocationID.x</code> para obtener el índice del vértice para el cual queremos calcular las tangentes. Opté por poner el cálculo actual en su propio método. Veamos eso.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code>ModelVertex <span class="token function">calcTangentBitangent</span><span class="token punctuation">(</span><span class="token keyword">uint</span> vertexIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ModelVertex v <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>vertexIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> tangent <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> bitangent <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint</span> trianglesIncluded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// Find the triangles that use v</span>
    <span class="token comment">//  * Loop over every triangle (i + 3)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numIndices<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">uint</span> index0 <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">uint</span> index1 <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">uint</span> index2 <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Only perform the calculation if one of the indices</span>
        <span class="token comment">// matches our vertexIndex</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index0 <span class="token operator">==</span> vertexIndex <span class="token operator">||</span> index1 <span class="token operator">==</span> vertexIndex <span class="token operator">||</span> index2 <span class="token operator">==</span> vertexIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ModelVertex v0 <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>index0<span class="token punctuation">]</span><span class="token punctuation">;</span>
            ModelVertex v1 <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>index1<span class="token punctuation">]</span><span class="token punctuation">;</span>
            ModelVertex v2 <span class="token operator">=</span> srcVertices<span class="token punctuation">[</span>index2<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">vec3</span> pos0 <span class="token operator">=</span> <span class="token function">getPos</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> pos1 <span class="token operator">=</span> <span class="token function">getPos</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> pos2 <span class="token operator">=</span> <span class="token function">getPos</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">vec2</span> uv0 <span class="token operator">=</span> <span class="token function">getUV</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec2</span> uv1 <span class="token operator">=</span> <span class="token function">getUV</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec2</span> uv2 <span class="token operator">=</span> <span class="token function">getUV</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">vec3</span> delta_pos1 <span class="token operator">=</span> pos1 <span class="token operator">-</span> pos0<span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> delta_pos2 <span class="token operator">=</span> pos2 <span class="token operator">-</span> pos0<span class="token punctuation">;</span>

            <span class="token keyword">vec2</span> delta_uv1 <span class="token operator">=</span> uv1 <span class="token operator">-</span> uv0<span class="token punctuation">;</span>
            <span class="token keyword">vec2</span> delta_uv2 <span class="token operator">=</span> uv2 <span class="token operator">-</span> uv0<span class="token punctuation">;</span>

            <span class="token keyword">float</span> r <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>delta_uv1<span class="token punctuation">.</span>x <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>y <span class="token operator">-</span> delta_uv1<span class="token punctuation">.</span>y <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tangent <span class="token operator">+=</span> <span class="token punctuation">(</span>delta_pos1 <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>y <span class="token operator">-</span> delta_pos2 <span class="token operator">*</span> delta_uv1<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
            bitangent <span class="token operator">+=</span> <span class="token punctuation">(</span>delta_pos2 <span class="token operator">*</span> delta_uv1<span class="token punctuation">.</span>x <span class="token operator">-</span> delta_pos1 <span class="token operator">*</span> delta_uv2<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
            trianglesIncluded <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">// Average the tangent and bitangents</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trianglesIncluded <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tangent <span class="token operator">/=</span> trianglesIncluded<span class="token punctuation">;</span>
        bitangent <span class="token operator">/=</span> trianglesIncluded<span class="token punctuation">;</span>
        tangent <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>tangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bitangent <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>bitangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Save the results</span>
    v<span class="token punctuation">.</span>tx <span class="token operator">=</span> tangent<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>ty <span class="token operator">=</span> tangent<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>tz <span class="token operator">=</span> tangent<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>bx <span class="token operator">=</span> bitangent<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>by <span class="token operator">=</span> bitangent<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    v<span class="token punctuation">.</span>bz <span class="token operator">=</span> bitangent<span class="token punctuation">.</span>z<span class="token punctuation">;</span>

    <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="posibles-mejoras"><a href="#posibles-mejoras" class="header-anchor">#</a> Posibles Mejoras</h2> <p>Hacer un bucle sobre cada triángulo para cada vértice probablemente levante algunas banderas rojas para algunos de ustedes. En un contexto de un solo hilo, este algoritmo terminaría siendo O(N*M). Como estamos utilizando el alto número de hilos disponibles en nuestra GPU, esto es menos problemático, pero aún significa que nuestra GPU está quemando más ciclos de los que necesita.</p> <p>Una forma en que se me ocurrió posiblemente mejorar el rendimiento es almacenar el índice de cada triángulo en una estructura como un mapa hash con el índice del vértice como claves. Aquí hay un pseudocódigo:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>indices<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token punctuation">{</span>
    triangle_map<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>t <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle_map<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>indices<span class="token punctuation">[</span>t <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle_map<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>indices<span class="token punctuation">[</span>t <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Luego necesitaríamos aplanar esta estructura para pasarla a la GPU. También necesitaríamos un segundo arreglo para indexar el primero.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span>_v<span class="token punctuation">,</span> t_list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> triangle_map<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    triangle_map_indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">TriangleMapIndex</span> <span class="token punctuation">{</span>
        start<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
        len<span class="token punctuation">:</span> t_list<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flat_triangle_map<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>t_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finalmente decidí en contra de este método ya que era más complicado y no he tenido tiempo para comparar si es más rápido que el método simple.</p> <h2 id="resultados"><a href="#resultados" class="header-anchor">#</a> Resultados</h2> <p>Las tangentes y bitangentes ahora se calculan correctamente en la GPU.</p> <p><img src="/learn-wgpu-es/assets/img/results.db10ec4d.png" alt="./results.png"></p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/showcase/compute/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Última Actualización: </span> <span class="time">12/15/2025, 10:59:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu-es/showcase/pong/" class="prev">
          Pong
        </a></span> <span class="next"><a href="/learn-wgpu-es/showcase/alignment/">
          Diseño de Memoria en WGSL
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu-es/assets/js/app.fb31abca.js" defer></script><script src="/learn-wgpu-es/assets/js/2.1022e2be.js" defer></script><script src="/learn-wgpu-es/assets/js/1.4766453e.js" defer></script><script src="/learn-wgpu-es/assets/js/18.d64e2c10.js" defer></script><script src="/learn-wgpu-es/assets/js/22.5d980ee9.js" defer></script>
  </body>
</html>
