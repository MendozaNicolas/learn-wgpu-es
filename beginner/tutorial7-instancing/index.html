<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Instanciación | Learn Wgpu - Español</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/learn-wgpu-es/assets/css/0.styles.54a9523f.css" as="style"><link rel="preload" href="/learn-wgpu-es/assets/js/app.1da4b688.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/3.adbf9188.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/2.cb1a7929.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/48.4dde588d.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/33.aa64fba8.js" as="script"><link rel="preload" href="/learn-wgpu-es/assets/js/38.875f4ce4.js" as="script"><link rel="prefetch" href="/learn-wgpu-es/assets/js/1.4f48abed.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/10.b7e8940b.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/11.73867170.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/12.67d9bb8e.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/13.7a96b491.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/14.5e178fd7.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/15.1fd30c11.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/16.e4f35d3f.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/17.d04aa74e.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/18.74b1431f.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/19.5c3d7990.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/20.7656e214.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/21.49c8df61.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/22.2d036121.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/23.91a69f99.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/24.4534de06.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/25.40057d50.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/26.b3486d9a.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/27.6b1e13e8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/28.14099108.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/29.0e81e00e.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/30.7ee6c9a8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/31.b9e79cb5.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/32.7b0790d0.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/34.f338917c.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/35.5a1ab6b4.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/36.bc32d842.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/37.38029664.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/39.ab729d62.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/4.2f7b6f81.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/40.6b168ce1.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/41.42966f50.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/42.a6f27c8d.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/43.bfae1c37.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/44.bca72294.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/45.f7af7c90.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/46.6bbbc12c.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/47.ca03fcd2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/49.98f35d73.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/5.5433791e.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/50.8ec43db8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/51.eaf78dc2.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/52.43facef0.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/53.33405d68.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/54.e3d2968f.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/55.b480d69c.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/56.f736ebcf.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/57.77aa79cc.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/58.a093ef01.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/59.6a0d92d8.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/6.c0282cbd.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/60.864b530f.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/61.b4bff856.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/62.31881615.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/63.2648fe69.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/64.3e547993.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/65.093678c1.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/66.67f025be.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/67.ac16597b.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/68.dd166fda.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/69.2123c238.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/70.51ee8101.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/71.72a0df5f.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/72.fc944211.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/73.66464f66.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/74.dc0b78b1.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/75.d0b7ef79.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/76.db3c1665.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/77.c9896c4b.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/9.6e2f5503.js"><link rel="prefetch" href="/learn-wgpu-es/assets/js/vendors~docsearch.0ad8ae62.js">
    <link rel="stylesheet" href="/learn-wgpu-es/assets/css/0.styles.54a9523f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu-es/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu - Español</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu-es/" aria-current="page" class="sidebar-link">Introducción</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Principiante</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-es/beginner/tutorial1-window/" class="sidebar-link">Dependencias y la ventana</a></li><li><a href="/learn-wgpu-es/beginner/tutorial2-surface/" class="sidebar-link">La Superficie</a></li><li><a href="/learn-wgpu-es/beginner/tutorial3-pipeline/" class="sidebar-link">El Pipeline</a></li><li><a href="/learn-wgpu-es/beginner/tutorial4-buffer/" class="sidebar-link">Búferes e Índices</a></li><li><a href="/learn-wgpu-es/beginner/tutorial5-textures/" class="sidebar-link">Texturas y grupos de enlace</a></li><li><a href="/learn-wgpu-es/beginner/tutorial6-uniforms/" class="sidebar-link">Búferes uniformes y una cámara 3D</a></li><li><a href="/learn-wgpu-es/beginner/tutorial7-instancing/" aria-current="page" class="active sidebar-link">Instanciación</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu-es/beginner/tutorial7-instancing/#el-bufer-de-instancias" class="sidebar-link">El Búfer de Instancias</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/beginner/tutorial7-instancing/#demostracion" class="sidebar-link">Demostración</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-es/beginner/tutorial7-instancing/#desafio" class="sidebar-link">Desafío</a></li></ul></li><li><a href="/learn-wgpu-es/beginner/tutorial8-depth/" class="sidebar-link">El Búfer de Profundidad</a></li><li><a href="/learn-wgpu-es/beginner/tutorial9-models/" class="sidebar-link">Carga de Modelos</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermedio</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-es/intermediate/tutorial10-lighting/" class="sidebar-link">Trabajando con Luces</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial11-normals/" class="sidebar-link">Mapeo de Normales</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial12-camera/" class="sidebar-link">Una Cámara Mejor</a></li><li><a href="/learn-wgpu-es/intermediate/tutorial13-hdr/" class="sidebar-link">Renderizado de Alto Rango Dinámico</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Compute Pipelines</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Noticias</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="instanciacion"><a href="#instanciacion" class="header-anchor">#</a> Instanciación</h1> <p>Nuestra escena en este momento es muy simple: tenemos un objeto centrado en (0,0,0). ¿Qué pasa si queremos más objetos? Aquí es donde entra en juego la instanciación.</p> <p>La instanciación nos permite dibujar el mismo objeto varias veces con propiedades diferentes (posición, orientación, tamaño, color, etc.). Hay múltiples formas de hacer instanciación. Una forma sería modificar el búfer uniforme para incluir estas propiedades y luego actualizarlo antes de dibujar cada instancia de nuestro objeto.</p> <p>No queremos usar este método por razones de rendimiento. Actualizar el búfer uniforme para cada instancia requeriría múltiples copias de búfer por fotograma. Además, nuestro método actual para actualizar el búfer uniforme nos requiere crear un nuevo búfer para almacenar los datos actualizados. Eso es mucho tiempo desperdiciado entre llamadas de dibujo.</p> <p>Si miramos los parámetros de la función <code>draw_indexed</code> <a href="https://docs.rs/wgpu/latest/wgpu/struct.RenderPass.html#method.draw_indexed" target="_blank" rel="noopener noreferrer">en la documentación de wgpu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, podemos ver una solución a nuestro problema.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">draw_indexed</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
    indices<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    base_vertex<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span> <span class="token comment">// &lt;-- This right here</span>
<span class="token punctuation">)</span>
</code></pre></div><p>El parámetro <code>instances</code> toma un <code>Range&lt;u32&gt;</code>. Este parámetro le dice a la GPU cuántas copias, o instancias, del modelo queremos dibujar. Actualmente, estamos especificando <code>0..1</code>, lo que instruye a la GPU a dibujar nuestro modelo una vez y luego detener. Si usáramos <code>0..5</code>, nuestro código dibujaría cinco instancias.</p> <p>El hecho de que <code>instances</code> sea un <code>Range&lt;u32&gt;</code> puede parecer raro, ya que usar <code>1..2</code> para instancias seguiría dibujando una instancia de nuestro objeto. Parece que sería más simple simplemente usar un <code>u32</code>, ¿verdad? La razón por la que es un rango es que a veces no queremos dibujar <strong>todos</strong> nuestros objetos. A veces queremos dibujar una selección de ellos porque otros no están en el marco, o estamos depurando y queremos mirar un conjunto particular de instancias.</p> <p>Bien, ahora sabemos cómo dibujar múltiples instancias de un objeto. ¿Cómo le decimos a wgpu qué instancia particular dibujar? Vamos a usar algo conocido como búfer de instancias.</p> <h2 id="el-bufer-de-instancias"><a href="#el-bufer-de-instancias" class="header-anchor">#</a> El Búfer de Instancias</h2> <p>Crearemos un búfer de instancias de manera similar a cómo creamos un búfer uniforme. Primero, crearemos una estructura llamada <code>Instance</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// lib.rs</span>
<span class="token comment">// ...</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Instance</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    rotation<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="note"><p>Un <code>Quaternion</code> es una estructura matemática que se usa frecuentemente para representar rotaciones. Las matemáticas detrás de ellas están fuera de mi alcance (involucran números imaginarios y espacio 4D), así que no las cubriré aquí. Si realmente quieres profundizar en ellas <a href="https://mathworld.wolfram.com/Quaternion.html" target="_blank" rel="noopener noreferrer">aquí hay un artículo de Wolfram Alpha<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>Usar estos valores directamente en el sombreador sería incómodo, ya que los cuaterniones no tienen un análogo en WGSL. No me siento como escribir las matemáticas en el sombreador, así que convertiremos los datos de <code>Instance</code> en una matriz y los almacenaremos en una estructura llamada <code>InstanceRaw</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Estos son los datos que irán en <code>wgpu::Buffer</code>. Los mantenemos separados para que podamos actualizar <code>Instance</code> tanto como queramos sin necesidad de lidiar con matrices. Solo necesitamos actualizar los datos sin procesar antes de dibujar.</p> <p>Crearemos un método en <code>Instance</code> para convertir a <code>InstanceRaw</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token keyword">impl</span> <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">to_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
        <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from_translation</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Ahora necesitamos añadir dos campos a <code>State</code>: <code>instances</code> e <code>instance_buffer</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    instances<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Instance</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>El crate <code>cgmath</code> usa características (traits) para proporcionar métodos matemáticos comunes en sus estructuras, como <code>Vector3</code>, que deben importarse antes de que se puedan llamar estos métodos. Por conveniencia, el módulo <code>prelude</code> dentro del crate proporciona los más comunes de estos crates de extensión cuando se importa.</p> <p>Para importar este módulo prelude, pon esta línea cerca de la parte superior de <code>lib.rs</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">cgmath<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
</code></pre></div><p>Crearemos las instancias en <code>new()</code>. Usaremos algunas constantes para simplificar las cosas. Mostraremos nuestras instancias en 10 filas de 10, y estarán espaciadas uniformemente.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Ahora podemos crear las instancias reales.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Window</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">State</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>z<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> x <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> z <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token punctuation">}</span> <span class="token operator">-</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> rotation <span class="token operator">=</span> <span class="token keyword">if</span> position<span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// this is needed so an object at (0, 0, 0) won't get scaled to zero</span>
                    <span class="token comment">// as Quaternions can affect scale if they're not created correctly</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">unit_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
                    position<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Ahora que tenemos nuestros datos, podemos crear el <code>instance_buffer</code> real.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_data <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Instance</span><span class="token punctuation">::</span>to_raw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Instance Buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contents<span class="token punctuation">:</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">VERTEX</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Vamos a necesitar crear un nuevo <code>VertexBufferLayout</code> para <code>InstanceRaw</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span> <span class="token punctuation">{</span>
            array_stride<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">InstanceRaw</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
            <span class="token comment">// We need to switch from using a step mode of Vertex to Instance</span>
            <span class="token comment">// This means that our shaders will only change to use the next</span>
            <span class="token comment">// instance when the shader starts processing a new instance</span>
            step_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexStepMode</span><span class="token punctuation">::</span><span class="token class-name">Instance</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token comment">// A mat4 takes up 4 vertex slots as it is technically 4 vec4s. We need to define a slot</span>
                <span class="token comment">// for each vec4. We'll have to reassemble the mat4 in the shader.</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token comment">// While our vertex shader only uses locations 0, and 1 now, in later tutorials, we'll</span>
                    <span class="token comment">// be using 2, 3, and 4, for Vertex. We'll start at slot 5, not conflict with them later</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Necesitamos añadir este descriptor al pipeline de renderizado para que podamos usarlo cuando renderizamos.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    vertex<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexState</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// UPDATED!</span>
        buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Vertex</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InstanceRaw</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>¡No olvides retornar nuestras nuevas variables!</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NEW!</span>
    instances<span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>El último cambio que necesitamos hacer es en el método <code>render()</code>. Necesitamos vincular nuestro <code>instance_buffer</code> y cambiar el rango que usamos en <code>draw_indexed()</code> para incluir el número de instancias.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// NEW!</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// UPDATED!</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning"><p>Asegúrate de que si añades nuevas instancias al <code>Vec</code>, también recrees el <code>instance_buffer</code> y <code>camera_bind_group</code>. De lo contrario, tus nuevas instancias no aparecerán correctamente.</p></div> <p>Necesitamos referenciar las partes de nuestra nueva matriz en <code>shader.wgsl</code> para que podamos usarla para nuestras instancias. Añade lo siguiente en la parte superior de <code>shader.wgsl</code>.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">InstanceInput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">5</span><span class="token punctuation">)</span> model_matrix_0<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">6</span><span class="token punctuation">)</span> model_matrix_1<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">7</span><span class="token punctuation">)</span> model_matrix_2<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">8</span><span class="token punctuation">)</span> model_matrix_3<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Necesitamos rearmar la matriz antes de poder usarla.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    model<span class="token punctuation">:</span> <span class="token class-name">VertexInput</span><span class="token punctuation">,</span>
    instance<span class="token punctuation">:</span> <span class="token class-name">InstanceInput</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> model_matrix <span class="token operator">=</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>model_matrix_0<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_1<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_2<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_3<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Continued...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Aplicaremos <code>model_matrix</code> antes de aplicar <code>camera_uniform.view_proj</code>. Hacemos esto porque <code>camera_uniform.view_proj</code> cambia el sistema de coordenadas del <code>world space</code> al <code>camera space</code>. Nuestro <code>model_matrix</code> es una transformación del <code>world space</code>, así que no queremos estar en <code>camera space</code> cuando lo usamos.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    model<span class="token punctuation">:</span> <span class="token class-name">VertexInput</span><span class="token punctuation">,</span>
    instance<span class="token punctuation">:</span> <span class="token class-name">InstanceInput</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>tex_coords <span class="token operator">=</span> model<span class="token punctuation">.</span>tex_coords<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>view_proj <span class="token operator">*</span> model_matrix <span class="token operator">*</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>position<span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>¡Con todo eso hecho, deberíamos tener un bosque de árboles!</p> <p><img src="/learn-wgpu-es/assets/img/forest.5c5cf3ad.png" alt="./forest.png"></p> <h2 id="demostracion"><a href="#demostracion" class="header-anchor">#</a> Demostración</h2> <div id="wasm-example"><canvas id="canvas"></canvas> <!----> <!----> <!----> <button>
    Click to start Tutorial7_instancing!
  </button></div> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial7-instancing/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <h2 id="desafio"><a href="#desafio" class="header-anchor">#</a> Desafío</h2> <p>Modifica la posición y/o rotación de las instancias en cada fotograma.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Última Actualización: </span> <span class="time">12/15/2025, 10:51:18 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu-es/beginner/tutorial6-uniforms/" class="prev">
          Búferes uniformes y una cámara 3D
        </a></span> <span class="next"><a href="/learn-wgpu-es/beginner/tutorial8-depth/">
          El Búfer de Profundidad
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu-es/assets/js/app.1da4b688.js" defer></script><script src="/learn-wgpu-es/assets/js/3.adbf9188.js" defer></script><script src="/learn-wgpu-es/assets/js/2.cb1a7929.js" defer></script><script src="/learn-wgpu-es/assets/js/48.4dde588d.js" defer></script><script src="/learn-wgpu-es/assets/js/33.aa64fba8.js" defer></script><script src="/learn-wgpu-es/assets/js/38.875f4ce4.js" defer></script>
  </body>
</html>
